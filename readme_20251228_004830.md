# 基金交易系统

开放式基金交易系统微服务 - 基于FastAPI的RESTful API服务

## 📋 项目概述

本系统是一个基于FastAPI开发的基金交易微服务系统，提供用户管理、基金账户管理、基金申购赎回、资产管理等核心功能。系统采用模块化架构设计，支持多账户、多产品、多业务类型。

### 主要特性

- ✅ **模块化架构**：采用模块化设计，便于扩展和维护
- ✅ **完整集成版本**：整合模块化路由和兼容性端点，统一API接口
- ✅ **数据同步机制**：RepositoryAdapter 确保兼容性端点和模块化服务数据共享
- ✅ **RESTful API**：标准的RESTful接口设计，按业务模块分类组织
- ✅ **数据验证**：基于Pydantic V2的完整数据验证
- ✅ **交互式客户端**：提供命令行交互式客户端
- ✅ **API文档**：自动生成的Swagger/ReDoc文档，按标签分组
- ✅ **健康检查**：内置健康检查接口
- ✅ **CORS支持**：跨域资源共享配置
- ✅ **测试日志**：完整的测试日志记录功能，便于问题分析

## 🏗️ 系统架构

### 项目结构

```
fi/
├── main.py                    # FastAPI微服务入口（原始版本，v1.0.0）
├── main_v2.py                 # FastAPI微服务入口（完整集成版本，v2.0.0，推荐）
├── run_service.py             # 便捷启动脚本
├── models.py                  # Pydantic数据模型（原始版本）
├── repository.py              # 数据存储层（内存，原始版本）
├── service.py                 # 业务服务层（原始版本）
├── client.py                  # 客户端业务接口
├── interactive_client.py      # 交互式客户端
├── requirements.txt           # 项目依赖
├── test_api.py                # API测试脚本
├── test_modules.py            # 模块测试脚本
├── verify.py                  # 验证脚本
├── generate_modules.py        # 模块生成脚本
├── create_table_model_excel.py # 表模型Excel生成脚本
├── common/                    # 公共模块
│   ├── __init__.py
│   ├── enums.py              # 枚举定义
│   └── repository.py         # 统一数据存储层
├── modules/                   # 业务模块（模块化架构）
│   ├── user/                 # 用户模块（已实现）
│   │   ├── __init__.py
│   │   ├── user_schema.py    # 数据模型层
│   │   ├── user_app.py       # 业务逻辑层
│   │   ├── user_api.py       # API接口层
│   │   └── user_web.py       # Web路由层
│   ├── user_asset/           # 用户资产模块（已实现）
│   │   ├── __init__.py
│   │   ├── user_asset_schema.py
│   │   ├── user_asset_app.py
│   │   ├── user_asset_api.py
│   │   └── user_asset_web.py
│   ├── fund_account/         # 基金账户模块
│   │   ├── __init__.py
│   │   ├── fund_account_schema.py
│   │   ├── fund_account_app.py
│   │   ├── fund_account_api.py
│   │   └── fund_account_web.py
│   ├── fund_product/         # 基金产品模块
│   │   ├── __init__.py
│   │   ├── fund_product_schema.py
│   │   ├── fund_product_app.py
│   │   ├── fund_product_api.py
│   │   └── fund_product_web.py
│   ├── transaction_entrust/   # 交易委托模块
│   │   ├── __init__.py
│   │   ├── transaction_entrust_schema.py
│   │   ├── transaction_entrust_app.py
│   │   ├── transaction_entrust_api.py
│   │   └── transaction_entrust_web.py
│   ├── transaction_confirm/  # 交易确认模块
│   │   ├── __init__.py
│   │   ├── transaction_confirm_schema.py
│   │   ├── transaction_confirm_app.py
│   │   ├── transaction_confirm_api.py
│   │   └── transaction_confirm_web.py
│   ├── fund_share/           # 基金份额模块
│   │   ├── __init__.py
│   │   ├── fund_share_schema.py
│   │   ├── fund_share_app.py
│   │   ├── fund_share_api.py
│   │   └── fund_share_web.py
│   ├── bank_account/         # 银行账户模块
│   │   ├── __init__.py
│   │   ├── bank_account_schema.py
│   │   ├── bank_account_app.py
│   │   ├── bank_account_api.py
│   │   └── bank_account_web.py
│   ├── capital_entrust/      # 资金委托模块
│   │   ├── __init__.py
│   │   ├── capital_entrust_schema.py
│   │   ├── capital_entrust_app.py
│   │   ├── capital_entrust_api.py
│   │   └── capital_entrust_web.py
│   └── capital_settlement/   # 资金清算模块
│       ├── __init__.py
│       ├── capital_settlement_schema.py
│       ├── capital_settlement_app.py
│       ├── capital_settlement_api.py
│       └── capital_settlement_web.py
├── tests/                    # 测试目录
│   ├── __init__.py
│   ├── conftest.py           # pytest配置文件（路径配置）
│   ├── test_models.py        # 数据模型测试
│   ├── test_service.py       # 业务服务层测试
│   ├── test_client.py        # 客户端接口测试（带日志记录）
│   ├── test_integration.py   # 集成测试
│   ├── test_client.log       # 测试日志文件（自动生成）
│   └── README.md             # 测试说明
├── database/                 # 数据库相关
│   ├── schema.sql            # SQL建表语句
│   └── 表模型.xlsx           # Excel表模型
├── docs/                     # 文档目录
│   └── er图.png              # ER关系图
└── .vscode/                  # VS Code配置
    ├── launch.json           # 调试配置
    ├── tasks.json            # 任务配置
    └── settings.json         # Python设置
```

### 代码命名规范

#### 模块命名规范

每个业务模块遵循统一的命名规范，包含以下4个文件：

1. **`{module_name}_schema.py`** - 数据模型层
   - 定义Pydantic数据模型
   - 包含请求/响应模型
   - 数据验证规则

2. **`{module_name}_app.py`** - 业务逻辑层
   - 实现核心业务逻辑
   - 调用数据存储层
   - 业务规则验证

3. **`{module_name}_api.py`** - API接口层
   - 定义API接口方法
   - 参数处理和转换
   - 调用业务逻辑层

4. **`{module_name}_web.py`** - Web路由层
   - 定义FastAPI路由
   - 请求/响应处理
   - 注册到主应用

#### 文件命名规范

- **Python文件**: 使用小写字母和下划线（snake_case），如 `user_app.py`
- **模块目录**: 使用小写字母和下划线，如 `user_asset/`
- **类名**: 使用大驼峰命名（PascalCase），如 `UserApp`
- **函数/变量名**: 使用小写字母和下划线（snake_case），如 `create_user`
- **常量**: 使用大写字母和下划线，如 `DEFAULT_TOKEN`

#### 目录结构说明

- **根目录**: 包含主入口文件、配置文件、工具脚本
- **common/**: 公共模块，包含枚举定义和统一数据存储层
- **modules/**: 业务模块目录，每个模块独立目录
- **tests/**: 测试文件目录
- **database/**: 数据库相关文件（SQL脚本、表模型）
- **docs/**: 文档和图表
- **.vscode/**: VS Code开发环境配置

### 技术栈

- **Web框架**: FastAPI 0.104.1
- **ASGI服务器**: Uvicorn 0.24.0
- **数据验证**: Pydantic 2.5.0
- **HTTP客户端**: Requests 2.31.0
- **测试框架**: Pytest 7.4.3
- **Python版本**: 3.8+

## 🚀 快速开始

### 1. 环境要求

- Python 3.8+
- pip

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 启动服务

#### 方式一：使用启动脚本（推荐）

```bash
python run_service.py
```

#### 方式二：直接运行

```bash
# 运行模块化版本（推荐）
python main_v2.py

# 或运行原始版本
python main.py
```

#### 方式三：使用uvicorn

```bash
# 模块化版本
uvicorn main_v2:app --host 0.0.0.0 --port 8000 --reload

# 原始版本
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

### 4. 访问服务

服务启动后，可通过以下地址访问：

- **API根路径**: http://localhost:8000
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **健康检查**: http://localhost:8000/api/v1/health

### 5. 使用交互式客户端

```bash
python interactive_client.py
```

详细使用说明请参考：[交互式客户端使用指南](INTERACTIVE_CLIENT_GUIDE.md)

## 📚 核心功能

### 1. 用户管理
- 创建用户
- 查询用户信息
- 用户状态管理

### 2. 基金账户管理
- 开通基金账户（开户）
- 账户查询
- 账户状态管理

### 3. 基金产品管理
- 创建基金产品
- 查询产品列表
- 产品净值管理

### 4. 基金交易
- 基金申购
- 基金赎回
- 交易委托管理
- 交易确认

### 5. 资产管理
- 用户资产查询
- 基金持仓查询
- 资产计算

## 🔌 API接口

### 认证

所有API接口都需要Bearer Token认证：

```
Authorization: Bearer demo_token_2025
```

### API接口分类

#### 1. 系统管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/` | 服务信息和模块列表 |
| GET | `/api/v1/health` | 健康检查 |

#### 2. 用户管理
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/users` | 创建用户（兼容性端点） |
| GET | `/api/v1/users/{user_id}` | 查询用户（兼容性端点） |
| POST | `/api/v1/users` | 创建用户（模块化端点） |
| GET | `/api/v1/users/{user_id}` | 查询用户（模块化端点） |
| GET | `/api/v1/users` | 列出所有用户（模块化端点） |

#### 3. 基金账户管理
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/accounts/open` | 开通基金账户（兼容性端点） |
| POST | `/api/v1/fund-account` | 创建基金账户（模块化端点） |
| GET | `/api/v1/fund-account/{id}` | 查询基金账户（模块化端点） |

#### 4. 基金产品管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/products` | 查询产品列表（兼容性端点，含净值） |
| POST | `/api/v1/products` | 创建基金产品（兼容性端点） |
| POST | `/api/v1/fund-product` | 创建基金产品（模块化端点） |
| GET | `/api/v1/fund-product/{id}` | 查询基金产品（模块化端点） |

#### 5. 基金净值管理
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/nav` | 创建基金净值（兼容性端点） |

#### 6. 基金交易
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/funds/subscribe` | 申购基金（兼容性端点） |
| POST | `/api/v1/funds/redeem` | 赎回基金（兼容性端点） |
| POST | `/api/v1/transaction-entrust` | 创建交易委托（模块化端点） |
| GET | `/api/v1/transaction-entrust/{id}` | 查询交易委托（模块化端点） |
| POST | `/api/v1/transaction-confirm` | 创建交易确认（模块化端点） |
| GET | `/api/v1/transaction-confirm/{id}` | 查询交易确认（模块化端点） |

#### 7. 用户资产管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/v1/assets/{user_id}` | 查询用户资产（兼容性端点） |
| GET | `/api/v1/assets/{user_id}` | 查询用户资产（模块化端点） |
| GET | `/api/v1/assets/{user_id}/balance` | 查询用户余额（模块化端点） |

#### 8. 其他模块化端点
- **银行账户管理**: `/api/v1/bank-account`
- **资金委托管理**: `/api/v1/capital-entrust`
- **资金清算管理**: `/api/v1/capital-settlement`
- **基金份额管理**: `/api/v1/fund-share`

详细API文档请访问：http://localhost:8000/docs（按标签分组显示）

## 🧪 测试

### 运行测试

```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_models.py -v
pytest tests/test_service.py -v
pytest tests/test_client.py -v
pytest tests/test_integration.py -v

# 运行测试并显示覆盖率
pytest --cov=. --cov-report=html
```

### 测试结构

- `conftest.py`: pytest配置文件，自动配置Python路径
- `test_models.py`: 数据模型测试
- `test_service.py`: 业务服务层测试
- `test_client.py`: 客户端接口测试（带完整日志记录）
  - 自动记录测试执行过程
  - 日志文件：`tests/test_client.log`
  - 每次运行自动清空并记录新日志
- `test_integration.py`: 集成测试

### 测试日志

`test_client.py` 包含完整的日志记录功能：

- **日志文件**: `tests/test_client.log`
- **日志级别**: DEBUG（记录详细信息）
- **日志格式**: 时间戳、级别、模块名、行号、消息
- **自动清空**: 每次运行前自动清空旧日志
- **双重输出**: 同时输出到文件和控制台
- **编码支持**: UTF-8编码，支持中文日志

运行测试时，所有执行过程都会记录到日志文件中，便于分析和调试。

## 📖 文档

- [实现说明](README_IMPLEMENTATION.md) - 详细的技术实现说明
- [交互式客户端使用指南](INTERACTIVE_CLIENT_GUIDE.md) - 交互式客户端操作指南
- [操作手册](USER_MANUAL.md) - 用户操作手册
- [运维文档](OPERATIONS_MANUAL.md) - 运维部署文档
- [项目总结](PROJECT_SUMMARY.md) - 项目完成情况总结
- [重构指南](REFACTOR_GUIDE.md) - 模块化重构指南

## 🛠️ 开发

### VS Code配置

项目已配置VS Code运行和调试配置：

- **调试配置**: `.vscode/launch.json`
- **任务配置**: `.vscode/tasks.json`
- **Python设置**: `.vscode/settings.json`

### 代码结构

#### 原始版本（main.py）

- **models.py**: 数据模型定义（Pydantic）
- **repository.py**: 数据存储层（内存存储）
- **service.py**: 业务逻辑层
- **main.py**: FastAPI应用和路由定义

#### 模块化版本（main_v2.py，推荐）

- **main_v2.py**: FastAPI应用入口，完整集成版本
  - 整合模块化路由和兼容性端点
  - 按业务模块分类组织API（系统管理、用户管理、基金账户管理等）
  - 使用 `RepositoryAdapter` 实现数据同步
  - 支持36+个API端点，包含10个业务模块
- **common/**: 公共模块
  - `enums.py`: 枚举类型定义
  - `repository.py`: 统一数据存储层（单例模式）
- **modules/**: 业务模块
  - 每个模块包含4个文件：`*_schema.py`, `*_app.py`, `*_api.py`, `*_web.py`
  - 已实现模块：`user/`, `user_asset/`
  - 基础结构模块：`fund_account/`, `fund_product/`, `transaction_entrust/` 等
- **RepositoryAdapter**: 数据适配器
  - 桥接 `common/repository.py` 和 `repository.py`
  - 确保兼容性端点和模块化服务数据共享
  - 自动同步用户和账户数据到两个存储系统

#### 客户端和工具

- **client.py**: 客户端业务接口封装
- **interactive_client.py**: 交互式命令行客户端
- **generate_modules.py**: 模块生成工具
- **test_*.py**: 测试脚本

## ⚠️ 注意事项

1. **数据持久化**: 当前使用内存存储，服务重启后数据会丢失
2. **认证机制**: 当前使用简化的token认证（`demo_token_2025`），生产环境需要完善
3. **并发控制**: 生产环境需要添加并发控制机制
4. **事务管理**: 需要确保数据一致性
5. **错误处理**: 已实现基础错误处理，可根据需要扩展
6. **数据同步**: 使用 `RepositoryAdapter` 确保兼容性端点和模块化服务数据共享
7. **Pydantic版本**: 使用Pydantic V2，注意 `.dict()` 已废弃，使用 `.model_dump()` 替代

## 🔧 技术实现细节

### 数据存储架构

系统采用双层数据存储架构：

1. **common/repository.py**: 统一数据存储层（单例模式）
   - 模块化服务使用此存储
   - 通过 `get_repository()` 获取单例实例

2. **repository.py**: 原始数据存储层
   - 兼容性端点使用此存储
   - 通过 `RepositoryAdapter` 桥接

3. **RepositoryAdapter**: 数据适配器
   - 继承自 `Repository`，重写关键方法
   - `get_user()`: 从 `common_repo` 读取，确保数据共享
   - `create_user()`: 同时写入两个存储，确保数据同步
   - `create_fund_account()`: 同时写入两个存储，确保数据同步

### 数据同步机制

- **写入操作**: 兼容性端点创建的数据会同步到 `common_repo`
- **读取操作**: 兼容性端点从 `common_repo` 读取，确保与模块化服务数据一致
- **错误处理**: 如果同步失败，记录警告但不中断操作

### 已知问题和修复

#### ✅ 已修复问题

1. **数据不一致问题**（2025-12-28）
   - **问题**: `RepositoryAdapter.get_user()` 只从 `common_repo` 读取，但 `create_user()` 未重写，导致数据不一致
   - **修复**: 重写 `create_user()` 方法，确保同时写入两个存储
   - **状态**: ✅ 已修复并验证

2. **用户不存在错误**（2025-12-28）
   - **问题**: 通过兼容性端点创建的用户，在开通账户时提示"用户不存在"
   - **修复**: 实现 `RepositoryAdapter` 数据同步机制
   - **状态**: ✅ 已修复并验证

3. **Pydantic V2兼容性**（2025-12-28）
   - **问题**: 代码中使用 `.dict()` 方法，Pydantic V2已废弃
   - **修复**: 全部替换为 `.model_dump()`
   - **状态**: ✅ 已修复

4. **测试日志权限错误**（2025-12-28）
   - **问题**: Windows上日志文件被占用时无法删除
   - **修复**: 实现安全的日志文件清理机制
   - **状态**: ✅ 已修复

## 🔄 版本说明

- **v1.0.0**: 原始版本（main.py）
  - 单文件架构
  - 所有API端点集中定义
  - 使用 `repository.py` 存储

- **v2.0.0**: 完整集成版本（main_v2.py，推荐使用）
  - 模块化架构，10个业务模块
  - 整合模块化路由和兼容性端点
  - 按业务模块分类组织API（36+个端点）
  - 使用 `RepositoryAdapter` 实现数据同步
  - 支持Swagger UI按标签分组显示
  - 完整的测试日志记录功能

## 📝 许可证

本项目为内部项目，仅供学习和开发使用。

## 🤝 贡献

欢迎提交Issue和Pull Request。

## 📞 技术支持

如有问题，请查看：
- API文档：http://localhost:8000/docs
- 测试文档：tests/README.md
- 项目文档：docs/

---

## 📋 更新日志

### 2025-12-28
- ✅ 合并 `main.py` 和 `main_v2.py`，创建完整集成版本
- ✅ 实现 `RepositoryAdapter` 数据同步机制
- ✅ 修复数据不一致问题（用户创建和读取）
- ✅ 添加完整的测试日志记录功能
- ✅ 按业务模块分类组织API端点
- ✅ 更新所有Pydantic V2兼容性（`.dict()` → `.model_dump()`）
- ✅ 修复Windows日志文件权限问题

### 2025-12-27
- ✅ 添加测试日志记录功能
- ✅ 修复模块导入路径问题
- ✅ 完善Swagger UI配置

### 2025-12-14
- ✅ 初始版本发布

---

**最后更新**: 2025-12-28
